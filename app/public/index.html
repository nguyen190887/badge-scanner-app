<!DOCTYPE html>
<html>

<head>
	<title>Badge Scanner App</title>
	<meta name="viewport" content="width=device-width,initial-scale=1">
</head>

<body>
	<div>Scan image -> Get ID</div>
	<!-- <form method="POST" action="http://localhost:3000/badge/id"
		enctype="multipart/form-data"> -->
	<form>
		<input id="theImage" name="theImage" type="file" accept="image/*" capture="camera" />
		<button id="submitBtn">Submit</button>
	</form>

	<script src="https://sdk.amazonaws.com/js/aws-sdk-2.577.0.min.js"></script>
	<script type="text/javascript">

		function call(url, data) {
			var xhr = new XMLHttpRequest();
			xhr.open('POST', url);
			xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
			xhr.send(data);
			xhr.onreadystatechange = function () {
				if (xhr.readyState === XMLHttpRequest.DONE) {
					alert(xhr.responseText);
				} else {
					alert('failed !!!');
				}
			};
		}

		function processImage(e) {
			e.preventDefault();

			const file = document.getElementById('theImage').files[0];

			var reader = new FileReader();
			reader.onload = (function (theFile) {
				return function (e) {
					// const url = 'http://localhost:3000/badge/id'
					// call(url, e.target.result)

					process(e.target.result);
				};
			})(file);
			reader.readAsDataURL(file);
		}

		document.getElementById("submitBtn").addEventListener('click', processImage);

		function process(based64Image) {
			var image = null;
			var jpg = true;
			try {
				image = atob(based64Image.split("data:image/jpeg;base64,")[1]);

			} catch (e) {
				jpg = false;
			}
			if (jpg == false) {
				try {
					image = atob(based64Image.split("data:image/png;base64,")[1]);
				} catch (e) {
					alert("Not an image file Rekognition can process");
					return;
				}
			}
			//unencode image bytes for Rekognition DetectFaces API
			var length = image.length;
			imageBytes = new ArrayBuffer(length);
			var ua = new Uint8Array(imageBytes);
			for (var i = 0; i < length; i++) {
				ua[i] = image.charCodeAt(i);
			}
			//Call Rekognition
			DetectTexts(imageBytes);
		}

		function DetectTexts(imageData) {
			AWS.config.region = "us-east-1";
			AWS.config.credentials = {
				accessKeyId: 'id',
				secretAccessKey: 'key'
			};
			var rekognition = new AWS.Rekognition();
			var params = {
				Image: {
					Bytes: imageData
				}
			};
			rekognition.detectText(params, function (err, data) {
				if (err) console.log(err, err.stack); // an error occurred
				else {
					console.log('data', data);
				}
			});
		}
	</script>
</body>

</html>
